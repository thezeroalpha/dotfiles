#!/usr/bin/env bash
set -x
get_profile_id() {
  while read -r profid; do
    name=$(dconf read /org/gnome/terminal/legacy/profiles:/:"$profid"/visible-name | tr -d "'")
    if [ "$name" = "$1" ]; then
      echo "$profid"
      return
    fi
  done < <(dconf list /org/gnome/terminal/legacy/profiles:/ | grep ^: | tr -d ':/')
}
change_to_profile() {
  gsettings set org.gnome.Terminal.ProfilesList default "$(get_profile_id "$1")"
}

switch_to_dark() {
  if [ -x ~/.local/bin/wal ] &>/dev/null; then
    ~/.local/bin/wal -i "$HOME/Pictures/Backgrounds/dark.jpg"
  else
    gsettings set org.gnome.desktop.background picture-uri "file://$HOME/Pictures/Backgrounds/dark.jpg";
  fi
  gsettings set org.gnome.desktop.screensaver picture-uri "file://$HOME/Pictures/Backgrounds/dark-lock.jpg";
  gsettings set org.gnome.Terminal.Legacy.Settings theme-variant dark
  gsettings set org.gnome.shell.extensions.user-theme name 'Flat-Remix-Miami-Dark'
  gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark'
  ln -sf $HOME/.dotfiles/shell/p10k-dark.zsh ~/.p10k.zsh
  change_to_profile "Dark"
}
switch_to_light() {
  if [ -x ~/.local/bin/wal ] &>/dev/null; then
    ~/.local/bin/wal -i "$HOME/Pictures/Backgrounds/light.jpg" -l
  else
    gsettings set org.gnome.desktop.background picture-uri "file://$HOME/Pictures/Backgrounds/light.jpg";
  fi
  gsettings set org.gnome.desktop.screensaver picture-uri "file://$HOME/Pictures/Backgrounds/light-lock.jpg";
  gsettings set org.gnome.Terminal.Legacy.Settings theme-variant light
  gsettings set org.gnome.shell.extensions.user-theme name 'Flat-Remix-Miami'
  gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita'
  ln -sf $HOME/.dotfiles/shell/p10k-light.zsh ~/.p10k.zsh
  change_to_profile "Light"
}
restart_gnome_shell() {
  gnome-shell -r &>/dev/null &
  disown
}
restart_i3() {
  i3 restart
}
set_xcape() {
  if command -v xcape &> /dev/null; then
    setxkbmap -option 'caps:ctrl_modifier'
    xcape -e 'Caps_Lock=Escape'
  fi
}
switch_polybar() {
  "$HOME"/.config/polybar/polybar.sh
}

die() {
  echo "$1" >&2
  exit 1
}

[ $# -eq 1 ] || die "Need a theme."
if ! command -v i3 &>/dev/null; then
  echo "i3 not installed." >&2
  exit 1
fi
if ! command -v gsettings &>/dev/null; then
  echo "gsettings not installed." >&2
  exit 1
fi
if ! command -v gnome-shell &>/dev/null; then
  echo "gnome-shell not installed." >&2
  exit 1
fi

if [ "$1" = "dark" ]; then switch_to_dark
elif [ "$1" = "light" ]; then switch_to_light
else die "Either light or dark."
fi

if ! [ -z "$(pgrep i3)" ]; then
  restart_i3 &>/dev/null
elif ! [ -z "$(pgrep gnome-shell)" ]; then
  restart_gnome_shell
fi

sleep 3
set_xcape
