# vim: syntax=neomuttrc
# Receive
source secret
set imap_user=$my_personal_email
set imap_pass=$my_personal_pass_cmd
set folder = ~/.local/share/mail/$my_personal_email
set postponed = +Drafts
set trash = +Trash
set record = +Sent
set mbox = +Archive

# The setup with regular mutt
# set spoolfile = +Inbox
# unmailboxes *
# mailboxes +Inbox +Archive +Drafts +Tickets +Sent +Trash +Spam
#
# But to use notmuch, I need to use virtual mailboxes:
# (it's on the wishlist - https://github.com/neomutt/neomutt/issues/742)
unmailboxes *
unvirtual-mailboxes *
virtual-mailboxes \
  "Inbox (P)" "notmuch://?query=folder:$my_personal_email/Inbox" \
  "Archive (2M) (P)" "notmuch://?query=folder:$my_personal_email/Archive and date:2M..today" \
  "Drafts (P)" "notmuch://?query=folder:$my_personal_email/Drafts" \
  "Tickets (P)" "notmuch://?query=folder:$my_personal_email/Tickets" \
  "Sent (P)" "notmuch://?query=folder:$my_personal_email/Sent" \
  "Trash (P)" "notmuch://?query=folder:$my_personal_email/Trash" \
  "Spam (P)" "notmuch://?query=folder:$my_personal_email/Spam" \
  "Archive (All) (P)" "notmuch://?query=folder:$my_personal_email/Archive"

set spoolfile = "Inbox (P)"

set header_cache = '~/.cache/mutt/$my_personal_email/headers'
set message_cachedir = '~/.cache/mutt/$my_personal_email/bodies'

# Send
set realname=$my_name
set from=$my_personal_email
set sendmail="msmtp -a $my_personal_email"
set sendmail_wait = 0
alias me $realname <$my_personal_email>
set signature=""
set ssl_force_tls = yes
set ssl_starttls = yes

# Hook -- IMPORTANT!
account-hook $folder "set imap_user=$my_personal_email imap_pass=$my_personal_pass_cmd"

# Retrieve new email
macro index O "<shell-escape>mbsync -c ~/.config/mbsync/mbsyncrc $my_personal_email && notmuch-hook<enter>" "run mbsync to sync $my_personal_email"
macro index o "<shell-escape>mbsync -c ~/.config/mbsync/mbsyncrc $my_personal_email:INBOX,Sent && notmuch-hook<enter>" "run mbsync to sync all mail"

# Delete
macro index,pager d "\
<delete-message>\
<modify-labels-then-hide>-inbox -archive -draft -spam +trash -sent -unread<enter>"

# Actually delete
bind index,pager D purge-message

# Undelete
macro index,pager u "\
<undelete-message>\
<modify-labels-then-hide>-trash<enter>"

# Changing folders
macro index,pager gi "<change-vfolder>Inbox (P)<enter>" "go to Inbox"
macro index,pager ga "<change-vfolder>Archive (2M) (P)<enter>" "go to recent Archive"
macro index,pager gA "<change-vfolder>Archive (All) (P)<enter>" "go to Archive"
macro index,pager gd "<change-vfolder>Drafts (P)<enter>" "go to Drafts"
macro index,pager gj "<change-vfolder>Spam (P)<enter>" "go to Spam"
macro index,pager gt "<change-vfolder>Trash (P)<enter>" "go to Trash"
macro index,pager gs "<change-vfolder>Sent (P)<enter>" "go to Sent"

# Moving emails
macro index,pager MI "<modify-labels>+inbox -archive -draft -spam -trash -sent -unread<enter><save-message>=Inbox<enter>" "move mail to Inbox"
macro index,pager MA "<modify-labels>-inbox +archive -draft -spam -trash -sent -unread<enter><save-message>=Archive<enter>" "move mail to Archive"
macro index,pager a "<modify-labels>-inbox +archive -draft -spam -trash -sent -unread<enter><save-message>=Archive<enter>" "move mail to Archive"
macro index,pager MD "<modify-labels>-inbox -archive +draft -spam -trash -sent -unread<enter><save-message>=Drafts<enter>" "move mail to Drafts"
macro index,pager MJ "<modify-labels>-inbox -archive -draft +spam -trash -sent -unread<enter><save-message>=Spam<enter>" "move mail to Spam"
macro index,pager MT "<modify-labels>-inbox -archive -draft -spam +trash -sent -unread<enter><save-message>=Trash<enter>" "move mail to Trash"
macro index,pager MS "<modify-labels>-inbox -archive -draft -spam -trash +sent -unread<enter><save-message>=Sent<enter>" "move mail to Sent"
