# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block, everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

source_if_exists() {
  if [[ -f "$1" ]]; then
    source "$1"
  fi
}

# Allow comments in shell
setopt interactivecomments

# Enable extra completions
fpath=($DOTFILES/shell/zsh-completions/src $fpath)
autoload -Uz compinit
compinit
source $DOTFILES/shell/oh-my-zsh-defaults/completion.zsh
source $DOTFILES/shell/oh-my-zsh-defaults/directories.zsh

# Auto correct commands, with exceptions (from oh-my-zsh)
if [[ "$ENABLE_CORRECTION" == "true" ]]; then
  alias cp='nocorrect cp'
  alias ebuild='nocorrect ebuild'
  alias gist='nocorrect gist'
  alias heroku='nocorrect heroku'
  alias hpodder='nocorrect hpodder'
  alias man='nocorrect man'
  alias mkdir='nocorrect mkdir'
  alias mv='nocorrect mv'
  alias mysql='nocorrect mysql'
  alias sudo='nocorrect sudo'

  setopt correct_all
fi

# Import colorscheme from 'wal' asynchronously
# &   # Run the process in the background.
# # ( ) # Hide shell job control messages.
(cat ~/.cache/wal/sequences &)

# # To add support for TTYs this line can be optionally added.
. ~/.cache/wal/colors-tty.sh


# Enable virtualenvwrapper if installed
if [ -f /usr/local/bin/virtualenvwrapper.sh ]; then
  export WORKON_HOME=$HOME/.config/virtualenvs
  export VIRTUALENVWRAPPER_PYTHON=`which python3`
  export VIRTUALENVWRAPPER_SCRIPT=/usr/local/bin/virtualenvwrapper.sh
  mkdir -p $WORKON_HOME
  source /usr/local/bin/virtualenvwrapper_lazy.sh
fi

# Powerlevel10k theme
source_if_exists ~/.p10k.zsh
source_if_exists $DOTFILES/shell/powerlevel10k/powerlevel10k.zsh-theme

# The 'z' command to jump around dirs
source_if_exists $DOTFILES/shell/z/z.sh

# FZF for fuzzy finding
source_if_exists ~/.fzf.zsh

# Enable custom aliases and functions
source_if_exists ~/.aliases
source_if_exists ~/.functions

insert-arg-of-prev-cmd() {
: ${NUMERIC:-1}
(( NUMERIC++ ))
words=($(fc -ln -1))
RBUFFER+="$words[$NUMERIC] "
zle end-of-line
}
zle -N insert-arg-of-prev-cmd
bindkey "\e^y" insert-arg-of-prev-cmd

bindkey '\e#' pound-insert
bindkey '^]' vi-find-next-char
bindkey '^\e]' vi-find-prev-char

# Use lf to switch directories and bind it to ctrl-o
lfcd () {
  if ! command -v lf &>/dev/null; then echo "lf not installed." && return; fi
  tmp="$(mktemp)"
  lf -last-dir-path="$tmp" "$@"
  if [ -f "$tmp" ]; then
    dir="$(cat "$tmp")"
    rm -f "$tmp"
    [ -d "$dir" ] && [ "$dir" != "$(pwd)" ] && cd "$dir"
  fi
}
bindkey -s '^o' 'lfcd\n'

test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

source_if_exists $DOTFILES/shell/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
